---
title: "White-Britt-ADA-data-reanalysis-assignment"
author: "BA White"
date: "4/15/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Data reanalysis of: Mahler, D. L., S. M. Lambert, A. J. Geneva, J. Ng, S. B. Hedges, J. B. Losos, and R. E. Glor. 2016. Discovery of a Giant Chameleon-Like Lizard (<i>Anolis</i>) on Hispaniola and Its Significance to Understanding Replicated Adaptive Radiations. The American Naturalist 188:357â€“364.

#Ecomorphological Affinities
##Goal: Quantify the ecomorphological similarity of new species to other anoles
###Using pPCA Revell (2009) on a covariance matrix of log-transformed and averaged data for body size and 
###shape residuals with the Bayesian MCC chronogram they calculated independent "size" and "shape" axes. 
###load necessary packages for data tidying and transformation
```{r}
library(tidyverse)
library(phytools) 
```
###load log-transformed and averaged size and shape data renamed as a tibble
```{r}
traits <- read_csv("Traits.csv", col_names = TRUE)
```
###see the variables in the tibble
```{r}
glimpse(traits)
```
###The Dryad "Traits.csv" contains 29 more species than their data table results and 2 species are swapped so...
```{r}
traits_3 <- read_csv("Traits_3.csv", col_names = TRUE)
glimpse(traits_3)
```
###these traits do not match what they ultimately included
```{r}
traits <- select(traits_3, c(1, 3:12))
traits
```
###load NEXUS tree file - they specify this NEXUS tree in their README file 
```{r}
tree <- read.nexus("5Loc_25milburn_100kthin.MCC.median.nex")
```
###The number of taxa in the data file and tree do not match
```{r}
tip_label <-tibble(tree$tip.label)

traits4tree <- traits %>% 
  semi_join(tip_label, c("species" = "tree$tip.label"))
```
#Trait datadrame must be a MATRIX with species as rownames of that matrix; as required by the pPCA
```{r}
sp <- traits4tree$species
t <- select(traits4tree,-species)
t <- as.matrix(t)
rownames(t) <- sp
```
###prune the branches of the tree for species not found in the morphology dataset 
```{r}
pruned.tree<-drop.tip(tree,tree$tip.label[-match(traits4tree$species, tree$tip.label)])
```
###the 'traits4tree' data have been averaged and log transformed by the original author but they still require size correction between the species pPCA. To do this we will conduct a phylogenetic regression against SVL (using phytools) then collect the residuals for each trait value. 
```{r}
SVL4pgls <- select(traits4tree, Avg_lnSVL2)
SVL4pgls <- as.matrix(SVL4pgls)
rownames(SVL4pgls) <- sp

traits_as_resids <- phyl.resid(pruned.tree, SVL4pgls, t, method="BM")
output <- matrix(unlist(traits_as_resids$resid), ncol = 10, byrow = TRUE)
rownames(output) <- sp

```
###build the model of phylogenetic relationships to the covariance matrix of traits to determine if 
### covariance occurs at a rate greater than expected by Brownian Motion
```{r}
pPCA <- phyl.pca(pruned.tree, output, method="BM", mode="cov")
pPCA
summary(pPCA)
```
###visualize in screeplot the PCAs
```{r}
plot(pPCA)
```
##Calculate the Euclidean distance to every other species in by the first four axes of a phylogenetic PCA on traits. 

##Conducted a 7-category linear discriminant analysis (LDA) on traditional ecomorph class for the four cryptic
giants in our sample (A. landestoyi, A. chamaeleonides, A. guamuhaya, A. porcus) plus
all species assigned to one of the six traditional ecomorph classes

```